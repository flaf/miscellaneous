#!/bin/sh

set -e

export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
export LC_ALL='C'

domain=$(hostname --domain)
realm=$(echo "$domain" | tr '[:lower:]' '[:upper:]')
windows_domain=${realm%.*}

invoke-rc.d samba stop

rm -f /etc/samba/smb.conf
rm -rf /var/lib/samba/private/*

samba-tool domain provision --realm="$realm"             \
                            --domain="$windows_domain"   \
                            --server-role=dc             \
                            --dns-backend=SAMBA_INTERNAL \
                            --adminpass='@admin7+8'      \
                            --use-rfc2307

cat >/etc/resolv.conf <<EOF
domain $domain
search $domain
nameserver <%= @ipaddress %>

EOF

sleep 1 && invoke-rc.d samba start


