<%-|
  String[1] $puppet_bin,
  String[1] $logfile,
  String[1] $flag_puppet_run_at_reboot,
|-%>
#!/bin/sh

### This file is managed by Puppet, please don't edit it. ###

export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
export LC_ALL='C'

script_name="${0##*/}"
puppet_bin='<%= $puppet_bin %>'
logfile='<%= $logfile %>'
flag_puppet_run_at_reboot='<%= $flag_puppet_run_at_reboot %>'

create_logfile () {
    touch "$logfile"
    chmod '0600' "$logfile"
}

set -e

create_logfile

# Redirect stdout and stderr in the log file.
exec >> "$logfile" 2>&1

printf '\n\n\n===> %s: start of %s...\n' "$(date)" "$script_name"

if [ -f "$flag_puppet_run_at_reboot" ]
then
    printf '\nThe flag file is present, the puppet cron will be launched in 60 seconds...\n'
    rm "$flag_puppet_run_at_reboot"
    sleep 60
    # If there are changes, the exit code is not zero.
    "$puppet_bin" agent --test --color='false' || true
    printf '\nPuppet run executed, end of script.\n'
else
    printf '\nNo flag file present, end of script.\n'
fi


