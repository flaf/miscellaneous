#!/bin/sh

### This file is managed by Puppet, don't edit it! ###

<%- if @admins_mails.is_a?(Array) and not @admins_mails.empty? -%>
# OK (array non vide)
<%- else -%>
# KO. ! (array non vide)
<%- end -%>

export LC_ALL=C
export PATH="/usr/sbin:/usr/bin:/sbin:/bin"

git_directory='<%= @git_directory %>'
git_directory_path="/etc/icecast2/$git_directory"
git_lockfile="$git_directory_path/<%= @git_lockfile %>"
mountpoints_file="$git_directory_path/<%= @mountpoints_file %>"

awk_prog='{
    if ($0 ~ /^<!--Mountpoints here-->/) {
        system("cat \"'"$mountpoints_file"'\"")
    } else {
        print $0
    }
}'

# Returns 0 if there is no lockfile, else returns 1.
wait_lockfile_out () {
    local c
    c=0
    while [ -e "$git_lockfile" ]
    do
        c=$((c+1))
        sleep 1
        [ "$c" = '10' ] && return 1
    done
    return 0
}

print_new_conf () {
    if [ -e "$mountpoints_file" ]
    then
        # In this case, there is a mountpoints file and a
        # git repository.
        awk "$awk_prog" "/etc/icecast2/icecast.xml.puppet"
    else
        # In this case, there is no git repository.
        cat "/etc/icecast2/icecast.xml.puppet"
    fi
}


case "$1" in

    start)
        invoke-rc.d icecast2 start
        sleep 1
        # To have a exit code equal to 0 only if icecast2
        # is really started.
        netstat -ltnp | grep -Eq '[0-9]+/icecast2'; exit $?
    ;;

    restart)
        invoke-rc.d icecast2 restart
        sleep 1
        # To have a exit code equal to 0 only if icecast2
        # is really restarted.
        netstat -ltnp | grep -Eq '[0-9]+/icecast2'; exit $?
    ;;

    status)
        # To have a exit code equal to 0 only if icecast2
        # is really restarted.
        netstat -ltnp | grep -Eq '[0-9]+/icecast2'; exit $?
    ;;

    update-conf)
        if wait_lockfile_out
        then
            print_new_conf > "/etc/icecast2/icecast.xml"
            exit 0
        else
            # Update later.
            exit 1
        fi
    ;;

    is-updated)
        if wait_lockfile_out
        then
            # Lockfile is out.
            print_new_conf | diff -q - "/etc/icecast2/icecast.xml" 1>/dev/null 2>&1; exit $?
        else
            # Lockfile is present.
            # In this case, we decide that the configuration
            # isn't updated.
            exit 1
        fi
    ;;

    *)
        echo "Sorry argument unknown."
        exit 1
    ;;

esac


