#!/bin/sh

### This file is managed by Puppet, don't edit it! ###

export LC_ALL=C
export PATH="/usr/sbin:/usr/bin:/sbin:/bin"

case "$1" in

    start)
        invoke-rc.d icecast2 start
        sleep 1
        # To have a exit code equal to 0 only if icecast2
        # is really started.
        netstat -ltnp | grep -Eq '[0-9]+/icecast2'; exit $?
    ;;

    restart)
        invoke-rc.d icecast2 restart
        sleep 1
        # To have a exit code equal to 0 only if icecast2
        # is really restarted.
        netstat -ltnp | grep -Eq '[0-9]+/icecast2'; exit $?
    ;;

    status)
        # To have a exit code equal to 0 only if icecast2
        # is really restarted.
        netstat -ltnp | grep -Eq '[0-9]+/icecast2'; exit $?
    ;;

    update-conf)
        cat "/etc/icecast2/icecast.xml.puppet" > "/etc/icecast2/icecast.xml"
    ;;

    is-updated)
        # If there is no rsa keys, we create they.
        #[ -e ~/.ssh/id_rsa ] || ssh-keygen -t rsa -N '' -f ~/.ssh/id_rsa

        #cd /etc/icecast2/ || exit
        #if [ ! -d /etc/icecast2/mountpoints ]
        #then
        #  if timeout 10 git clone "<%= @git_repository %>" mountpoints
        #  then
        #  fi

        #fi
        #if timeout 10 git clone <%= @git_repository %> test
        #then
        #  cd test && timeout 10 git pull
        #fi

        # If there is no change, then diff return 0 and the configuration
        # is updated.
        diff "/etc/icecast2/icecast.xml.puppet" "/etc/icecast2/icecast.xml"
    ;;

    *)
        echo "Sorry argument unknown."
        exit 1
    ;;

esac


