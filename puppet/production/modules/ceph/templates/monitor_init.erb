#!/bin/sh
### This is a file managed by Puppet, don't edit it. ###
<%- monitor_init = scope['::ceph::monitor_init'] -%>

# The name of the cluster.
cluster='<%= scope['::ceph::cluster_name'] %>'

# The hostname of the initial monitor.
monitor_init='<%= scope['::ceph::monitor_init'] %>'

# The ID of the initial monitor.
monitor_id='<%= scope['::ceph::monitors'][monitor_init]['id'] %>'

# The IP address of the initial monitor.
monitor_address='<%= scope['::ceph::monitors'][monitor_init]['address'] %>'

# The shared monitors key.
monitors_key='<%= scope['::ceph::monitors_key'] %>'

if [ -e "/var/lib/ceph/mon/$cluster-$monitor_id/upstart" ]
then
    echo "Sorry but the monior initialization seems to have already been launched."
    echo "End of the script."
    exit 1
fi

# Create a file which defines the rights of the monitors in
# the cluster. The same key will be shared with the monitors
# to ensure authentication between them (to ensure that the
# monitors belong to the same cluster).
ceph-authtool --create-keyring "/tmp/$cluster.mon.keyring" \
    -n mon. --cap mon 'allow *' -a "$monitors_key"

# Below, the same command as above where the key is generated
# automatically.
#
#   ceph-authtool --create-keyring "/tmp/$cluster.mon.keyring" \
#       -n mon. --cap mon 'allow *' --gen-key

# This command just appends the contents of the file given by
# the --import-keyring option to the file given as argument.
ceph-authtool --import-keyring "/etc/ceph/$cluster.client.admin.keyring" \
     "/tmp/$cluster.mon.keyring"

# Generate a monitor map which represents the cluster
# topology regarding the monitors. Currently, the topology
# will be very simple: just one monitor. The generated file
# is non human readable.
monmaptool --create --add "$monitor_id" "$monitor_address" \
    --fsid "$fsid" "/tmp/monmap"

# Initialization of the monitor working directory in
# "/var/lib/ceph/mon/$cluster-$monitor_id". To do that, the command
# provides:
#       - the fsid of the cluster (in the conf file);
#       - the secret shared monitor key and the key of client.admin
#         (in /tmp/$cluster.mon.keyring);
#       - the initial monitor map (in /tmp/monmap)
#
# Note: the key of client.admin is a key shared between the
# administrator (which will use ceph clients in command lines)
# and the monitors.
#
ceph-mon --mkfs -i "$monitor_id" --conf "/etc/ceph/$cluster.conf" \
    --monmap "/tmp/monmap" --keyring "/tmp/$cluster.mon.keyring"  \
    --cluster "$cluster"

# Delete the files in /tmp/.
rm "/tmp/$cluster.mon.keyring"
rm "/tmp/monmap"

# Without these files, the monitor daemon doesn't start.
touch "/var/lib/ceph/mon/$cluster-$monitor_id/done"
touch "/var/lib/ceph/mon/$cluster-$monitor_id/upstart"

# Start the monitor daemon.
stop ceph-mon-all cluster="$cluster" id="$monitor_id"
start ceph-mon-all cluster="$cluster" id="$monitor_id"
# Another way (more radical)
#   stop ceph-all
#   start ceph-all


