#!/bin/sh

set -e

export PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin'
export LC_ALL='C'

domain=$(hostname --domain)
realm=$(echo "$domain" | tr '[:lower:]' '[:upper:]')
windows_domain=${realm%.*}

invoke-rc.d samba stop

rm -f /etc/samba/smb.conf
rm -rf /var/lib/samba/private/*

samba-tool domain provision --realm="$realm"             \
                            --domain="$windows_domain"   \
                            --server-role=dc             \
                            --dns-backend=SAMBA_INTERNAL \
                            --adminpass='@admin7+8'      \
                            --use-rfc2307

cat >/etc/resolv.conf <<EOF
domain $domain
search $domain
nameserver <%= @ipaddress %>

EOF

sleep 1 && invoke-rc.d samba start


# /usr/local/samba/bin/samba-tool domain provision --realm="ATHOME.PRIV" --domain="ATHOME" --server-role=dc --dns-backend=SAMBA_INTERNAL --adminpass='@admin7+8' --use-rfc2307


# /usr/local/samba/sbin/samba -i -M single

# wget https://ftp.samba.org/pub/ldb/ldb-1.1.17.tar.gz

# Dans le smb.conf afin de virer ipv6 et de ne pas avoir d'erreur
#bind interfaces only = yes
#interfaces = 127.0.0.1 172.31.5.1

